<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google æ‰¹é‡ç¿»è¯‘</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 90%; max-width: 1000px; }
        h2 { color: #4285F4; margin-bottom: 20px; }
        
        .controls { 
            display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; 
            background: #e8f0fe; padding: 20px; border-radius: 8px; border: 1px solid #d2e3fc;
        }
        
        input[type="text"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #4285F4; border-radius: 5px; font-family: monospace; }
        select, input[type="file"] { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; color: white; font-size: 14px; }
        
        .btn-translate { background-color: #4285F4; }
        .btn-translate:hover { background-color: #3367d6; }
        .btn-export { background-color: #34a853; }
        .btn-export:hover { background-color: #2d8e46; }
        .btn-csv { background-color: #fbbc05; color: #333; }
        .btn-csv:hover { background-color: #f9a825; }
        button:disabled { background-color: #ccc; cursor: not-allowed; color: #fff; }

        .table-wrapper { max-height: 500px; overflow: auto; border: 1px solid #ddd; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f8f9fa; cursor: pointer; position: sticky; top: 0; z-index: 10; }
        th:hover { background-color: #e2e6ea; }
        .selected-col { background-color: #e8f0fe; }
        th.selected-header { background-color: #4285F4; color: white; }
        
        .progress-container { width: 100%; background-color: #eee; border-radius: 10px; margin-top: 15px; display: none; }
        .progress-bar { height: 10px; width: 0%; background-color: #4285F4; border-radius: 10px; transition: width 0.3s; }
        .status { margin-top: 10px; color: #555; font-size: 14px; white-space: pre-wrap; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸš€ Google æ‰¹é‡ç¿»è¯‘ (æœ€ç»ˆç¨³å®šç‰ˆ)</h2>
        
        <label style="font-weight: bold; display:block; margin-bottom:5px;">ç²˜è´´ Google Script URL:</label>
        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/AKfycbzjCrd4SIwoR_6M9Dx_3Lgm-Y4xFd8VBgmV2btY-L4XYkuXuUPuDPA2E7BWa8UwADdvFA/exec" />

        <div class="controls">
            <label>æºè¯­è¨€:</label>
            <select id="sourceLang">
                <option value="en">è‹±è¯­ (English)</option>
                <option value="nl">è·å…°è¯­ (Dutch)</option>
                <option value="de">å¾·è¯­ (German)</option>
                <option value="fr">æ³•è¯­ (French)</option>
                <option value="ja">æ—¥è¯­ (Japanese)</option>
                <option value="ko">éŸ©è¯­ (Korean)</option>
                <option value="auto">è‡ªåŠ¨æ£€æµ‹ (Auto)</option>
            </select>
            <span>â¡ ä¸­æ–‡ (zh-CN)</span>

            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" />
            
            <button id="btnTranslate" class="btn-translate" disabled>å¼€å§‹æ‰¹é‡ç¿»è¯‘</button>
            <button id="btnExport" class="btn-export" disabled>å¯¼å‡º Excel (.xlsx)</button>
            <button id="btnExportCSV" class="btn-csv" disabled>å¯¼å‡º CSV (é˜²ä¹±ç )</button>
        </div>

        <div id="status" class="status">ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...</div>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="table-wrapper">
            <table id="dataTable"></table>
        </div>
    </div>

    <script>
        // ğŸŸ¢ æ–°å¢ï¼šä½¿ç”¨ Node.js æ–¹å¼å¼•å…¥åº“
        const XLSX = require('xlsx');
        let globalWorkbook = null;
        let globalData = [];
        let selectedColIndex = -1;

        const fileInput = document.getElementById('fileInput');
        const table = document.getElementById('dataTable');
        const statusDiv = document.getElementById('status');
        const btnTranslate = document.getElementById('btnTranslate');
        const btnExport = document.getElementById('btnExport');
        const btnExportCSV = document.getElementById('btnExportCSV');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const sourceLangSelect = document.getElementById('sourceLang');
        const scriptUrlInput = document.getElementById('scriptUrl');

        if(localStorage.getItem('gas_url')) {
            scriptUrlInput.value = localStorage.getItem('gas_url');
        }

        // --- 1. ä¿®å¤è¯»å–é€»è¾‘ï¼šæ”¹å›æœ€å®‰å…¨çš„è‡ªåŠ¨æ£€æµ‹ ---
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    // âŒ åˆ é™¤äº† {codepage: 65001}ï¼Œæ”¹å›è‡ªåŠ¨æ£€æµ‹
                    // è¿™æ ·æ— è®ºæ˜¯ xlsx è¿˜æ˜¯ csvï¼Œåº“éƒ½ä¼šè‡ªå·±åˆ¤æ–­ï¼Œä¸ä¼šæŠ¥é”™äº†
                    globalWorkbook = XLSX.read(data, {type: 'array'});
                    
                    const ws = globalWorkbook.Sheets[globalWorkbook.SheetNames[0]];
                    globalData = XLSX.utils.sheet_to_json(ws, {header: 1});
                    
                    if(globalData.length === 0) {
                        statusDiv.innerText = "âŒ æ–‡ä»¶æ˜¯ç©ºçš„ï¼";
                        return;
                    }
                    
                    renderTable();
                    statusDiv.innerText = `âœ… å·²åŠ è½½: ${file.name} (å…± ${globalData.length} è¡Œ)`;
                } catch(err) {
                    console.error("Read Error:", err);
                    statusDiv.innerText = `âŒ è¯»å–æ–‡ä»¶å¤±è´¥: ${err.message}\nè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«å…¶ä»–è½¯ä»¶å ç”¨ï¼Œæˆ–å°è¯•å¦å­˜ä¸ºæ ‡å‡† .xlsx æ ¼å¼`;
                }
            };
            
            reader.readAsArrayBuffer(file);
        });

        function renderTable() {
            table.innerHTML = '';
            if (globalData.length === 0) return;
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            globalData[0].forEach((cell, index) => {
                const th = document.createElement('th');
                th.innerText = cell ? String(cell).substring(0, 20) : `Col ${index+1}`;
                th.onclick = () => selectColumn(index);
                if (index === selectedColIndex) th.classList.add('selected-header');
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            const limit = Math.min(globalData.length, 50); 
            for (let i = 1; i < limit; i++) {
                const row = document.createElement('tr');
                const rowData = globalData[i];
                const maxCols = globalData[0].length;
                for (let j = 0; j < maxCols; j++) {
                    const td = document.createElement('td');
                    td.innerText = rowData[j] ? String(rowData[j]).substring(0, 50) : '';
                    if (j === selectedColIndex) td.classList.add('selected-col');
                    row.appendChild(td);
                }
                tbody.appendChild(row);
            }
            table.appendChild(tbody);
        }

        function selectColumn(index) {
            selectedColIndex = index;
            renderTable();
            btnTranslate.disabled = false;
            statusDiv.innerText = `å·²é€‰ä¸­ç¬¬ ${index+1} åˆ—`;
        }

        async function fetchBatchTranslate(textArray, sourceLang) {
            const apiUrl = scriptUrlInput.value.trim();
            const payload = { texts: textArray, source: sourceLang, target: "zh-CN" };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                
                const resultText = await response.text();
                // å°è¯•è§£æ JSONï¼Œå¦‚æœå‡ºé”™åˆ™æ‰“å°åŸå§‹å†…å®¹ä»¥ä¾¿è°ƒè¯•
                try {
                    const jsonResponse = JSON.parse(resultText);
                    if (jsonResponse.status === "success") {
                        return jsonResponse.data;
                    } else {
                        console.error("GAS Error:", jsonResponse.message);
                        return null;
                    }
                } catch(e) {
                    console.error("Invalid JSON:", resultText);
                    return null;
                }
            } catch (error) {
                console.error("Network Error:", error);
                return null;
            }
        }

        btnTranslate.addEventListener('click', async () => {
            if (selectedColIndex === -1) return;
            const apiUrl = scriptUrlInput.value.trim();
            if (!apiUrl) { alert("è¯·å…ˆç²˜è´´ Google Script URL"); return; }
            localStorage.setItem('gas_url', apiUrl);

            // ğŸŸ¢ ä¿®å¤å¼€å§‹ï¼šå¦‚æœæ˜¯ autoï¼Œå°±å˜æˆç©ºå­—ç¬¦ä¸²
            let sourceLang = sourceLangSelect.value;
            if (sourceLang === 'auto') {
                sourceLang = "";  // Google è§„å®šï¼šç©ºå­—ç¬¦ä¸² = è‡ªåŠ¨æ£€æµ‹
            }
            // ğŸŸ¢ ä¿®å¤ç»“æŸ
            btnTranslate.disabled = true;
            progressContainer.style.display = 'block';

            let batchData = [];
            let indices = [];
            const BATCH_SIZE = 50; 

            for (let i = 1; i < globalData.length; i++) {
                let text = globalData[i][selectedColIndex];
                if (text) {
                    batchData.push(String(text));
                    indices.push(i);
                }
            }

            const totalItems = batchData.length;
            let processedCount = 0;
            
            for (let k = 0; k < totalItems; k += BATCH_SIZE) {
                const chunkTexts = batchData.slice(k, k + BATCH_SIZE);
                const chunkIndices = indices.slice(k, k + BATCH_SIZE);
                statusDiv.innerText = `æ­£åœ¨ç¿»è¯‘... ${k}/${totalItems}`;

                const results = await fetchBatchTranslate(chunkTexts, sourceLang);

                if (results && results.length === chunkTexts.length) {
                    for (let r = 0; r < results.length; r++) {
                        globalData[chunkIndices[r]][selectedColIndex] = results[r];
                    }
                } else {
                    statusDiv.innerText += "\nâš ï¸ æœ¬æ‰¹æ¬¡ç¿»è¯‘é‡åˆ°ç½‘ç»œæ³¢åŠ¨ï¼Œè·³è¿‡...";
                }

                processedCount += chunkTexts.length;
                progressBar.style.width = Math.round((processedCount / totalItems) * 100) + "%";
                await new Promise(r => setTimeout(r, 200));
            }

            renderTable();
            statusDiv.innerText = "âœ… ç¿»è¯‘å®Œæˆï¼å»ºè®®ä½¿ç”¨ã€é»„è‰²æŒ‰é’®ã€‘å¯¼å‡ºä»¥é˜²ä¹±ç ã€‚";
            btnTranslate.disabled = false;
            btnExport.disabled = false;
            btnExportCSV.disabled = false;
        });

        // 2. å¯¼å‡º Excel
        btnExport.addEventListener('click', () => {
            const newSheet = XLSX.utils.aoa_to_sheet(globalData);
            const newWorkbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWorkbook, newSheet, "Translated");
            XLSX.writeFile(newWorkbook, "Translated_Result.xlsx");
        });

        // 3. å¯¼å‡º CSV (å¸¦ BOM å¤´ï¼Œè§£å†³ä¹±ç )
        btnExportCSV.addEventListener('click', () => {
            const ws = XLSX.utils.aoa_to_sheet(globalData);
            const csvContent = XLSX.utils.sheet_to_csv(ws);
            // ğŸŒŸ æ‰‹åŠ¨æ·»åŠ  BOM å¤´
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "Translated_Fix_GBK.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

    </script>
</body>
</html>