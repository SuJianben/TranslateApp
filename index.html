<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google æ‰¹é‡ç¿»è¯‘ + æ•°æ®åŒ¹é…å·¥å…·</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 90%; max-width: 1000px; margin-bottom: 30px; }
        h2 { color: #4285F4; margin-bottom: 20px; }
        
        .controls { 
            display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; 
            background: #e8f0fe; padding: 20px; border-radius: 8px; border: 1px solid #d2e3fc;
        }
        
        input[type="text"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #4285F4; border-radius: 5px; font-family: monospace; }
        select, input[type="file"] { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; color: white; font-size: 14px; }
        
        .btn-translate { background-color: #4285F4; }
        .btn-translate:hover { background-color: #3367d6; }
        .btn-export { background-color: #34a853; }
        .btn-export:hover { background-color: #2d8e46; }
        .btn-csv { background-color: #fbbc05; color: #333; }
        .btn-csv:hover { background-color: #f9a825; }
        button:disabled { background-color: #ccc; cursor: not-allowed; color: #fff; }

        .table-wrapper { max-height: 500px; overflow: auto; border: 1px solid #ddd; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f8f9fa; cursor: pointer; position: sticky; top: 0; z-index: 10; }
        th:hover { background-color: #e2e6ea; }
        .selected-col { background-color: #e8f0fe; }
        th.selected-header { background-color: #4285F4; color: white; }
        
        .progress-container { width: 100%; background-color: #eee; border-radius: 10px; margin-top: 15px; display: none; }
        .progress-bar { height: 10px; width: 0%; background-color: #4285F4; border-radius: 10px; transition: width 0.3s; }
        .status { margin-top: 10px; color: #555; font-size: 14px; white-space: pre-wrap; font-weight: bold; }

        /* ğŸŸ¢ VLOOKUP æ¨¡å—ä¸“ç”¨æ ·å¼ */
        .vlookup-box { background: #f8f9fa; padding: 15px; border-radius: 8px; flex: 1; min-width: 300px; border: 1px solid #e0e0e0; }
        .vlookup-box h4 { margin-top: 0; color: #333; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸš€ Google æ‰¹é‡ç¿»è¯‘ (v1.0.3)</h2>
        
        <label style="font-weight: bold; display:block; margin-bottom:5px;">ç²˜è´´ Google Script URL:</label>
        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec" />

        <div class="controls">
            <label>æºè¯­è¨€:</label>
            <select id="sourceLang">
                <option value="en">è‹±è¯­ (English)</option>
                <option value="nl">è·å…°è¯­ (Dutch)</option>
                <option value="de">å¾·è¯­ (German)</option>
                <option value="fr">æ³•è¯­ (French)</option>
                <option value="ja">æ—¥è¯­ (Japanese)</option>
                <option value="ko">éŸ©è¯­ (Korean)</option>
                <option value="auto">è‡ªåŠ¨æ£€æµ‹ (Auto)</option>
            </select>
            <div style="display:flex; align-items:center; gap:5px;">
                <span>â¡ ç›®æ ‡:</span>
                <input type="text" id="targetLangInput" value="zh-CN" placeholder="å¦‚: en, ja" style="width: 60px; padding: 8px; margin:0; text-align:center;" title="è¾“å…¥è¯­è¨€ä»£ç ">
                <a href="https://cloud.google.com/translate/docs/languages" target="_blank" style="font-size:12px; text-decoration:none; color:#4285F4;">ğŸ“‹ä»£ç è¡¨</a>
            </div>

            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" />
            
            <button id="btnTranslate" class="btn-translate" disabled>å¼€å§‹æ‰¹é‡ç¿»è¯‘</button>
            <button id="btnExport" class="btn-export" disabled>å¯¼å‡º Excel (.xlsx)</button>
            <button id="btnExportCSV" class="btn-csv" disabled>å¯¼å‡º CSV (é˜²ä¹±ç )</button>
        </div>

        <div id="status" class="status">ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...</div>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="table-wrapper">
            <table id="dataTable"></table>
        </div>
    </div>

    <div class="container" style="border-top: 5px solid #34a853;">
        <h2 style="color: #34a853;">ğŸ§² æ™ºèƒ½æ•°æ®åŒ¹é… (å®šç‚¹å†™å…¥)</h2>
        <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
            åŠŸèƒ½ï¼šæ ¹æ®å…³è”åˆ—ï¼ˆKeyï¼‰ï¼Œå°†å‰¯è¡¨çš„æ•°æ®<b>å¡«å…¥åˆ°ä¸»è¡¨æŒ‡å®šçš„æŸä¸€åˆ—</b>ï¼ˆç±»ä¼¼ Excel è¦†ç›–ç²˜è´´ï¼‰ã€‚
        </p>

        <div class="vlookup-controls" style="display: flex; gap: 20px; flex-wrap: wrap;">
            
            <div class="vlookup-box">
                <h4>ğŸ“ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ ä¸»è¡¨ (Target)</h4>
                <input type="file" id="mainFileInput" accept=".xlsx, .xls, .csv" />
                <div id="mainFileStatus" style="font-size: 12px; color: gray; margin-top: 5px;">æœªé€‰æ‹©æ–‡ä»¶</div>
                
                <label style="display:block; margin-top:15px; font-weight:bold;">1. ä¸»è¡¨å…³è”åˆ— (Key):</label>
                <select id="mainKeySelect" style="width:100%; margin-top:5px; border:1px solid #999;"><option>è¯·å…ˆä¸Šä¼ æ–‡ä»¶</option></select>

                <label style="display:block; margin-top:15px; font-weight:bold; color:#d93025;">2. æ•°æ®å†™å…¥åˆ°ä¸»è¡¨å“ªä¸€åˆ—?</label>
                <select id="mainTargetSelect" style="width:100%; margin-top:5px; border:2px solid #d93025; background:#fff0f0;"><option>è¯·å…ˆä¸Šä¼ æ–‡ä»¶</option></select>
                <small style="color:gray;">*å»ºè®®é€‰æ‹©ä¸€ä¸ªç©ºåˆ—ï¼Œå¦åˆ™åŸæœ‰æ•°æ®ä¼šè¢«è¦†ç›–</small>
            </div>

            <div class="vlookup-box">
                <h4>ğŸ“‚ ç¬¬äºŒæ­¥ï¼šä¸Šä¼ å‰¯è¡¨ (Source)</h4>
                <input type="file" id="lookupFileInput" accept=".xlsx, .xls, .csv" />
                <div id="lookupFileStatus" style="font-size: 12px; color: gray; margin-top: 5px;">æœªé€‰æ‹©æ–‡ä»¶</div>

                <label style="display:block; margin-top:15px; font-weight:bold;">3. å‰¯è¡¨å…³è”åˆ— (Key):</label>
                <select id="lookupKeySelect" style="width:100%; margin-top:5px; border:1px solid #999;"><option>è¯·å…ˆä¸Šä¼ æ–‡ä»¶</option></select>

                <label style="display:block; margin-top:10px; font-weight:bold;">4. è¦å¤åˆ¶çš„æ•°æ® (Value):</label>
                <select id="lookupValueSelect" style="width:100%; margin-top:5px; border:1px solid #34a853;"><option>è¯·å…ˆä¸Šä¼ æ–‡ä»¶</option></select>
            </div>
        </div>

        <div style="margin-top: 25px; text-align: center;">
            <button id="btnMatch" style="background-color: #34a853; padding: 12px 40px; font-size: 16px;" disabled>å¼€å§‹å®šç‚¹å†™å…¥</button>
            <button id="btnExportMerged" style="background-color: #fbbc05; color:#333; padding: 12px 40px; font-size: 16px;" disabled>å¯¼å‡ºç»“æœ</button>
        </div>

        <div id="matchStatus" class="status" style="text-align: center; margin-top: 15px;">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        const XLSX = require('xlsx');

        // ==========================================
        //  ğŸ‘‡ æ¨¡å— 1ï¼šç¿»è¯‘åŠŸèƒ½ JS ä»£ç  (ä¿æŒä¸å˜)
        // ==========================================
        let globalWorkbook = null;
        let globalData = [];
        let selectedColIndex = -1;

        const fileInput = document.getElementById('fileInput');
        const table = document.getElementById('dataTable');
        const statusDiv = document.getElementById('status');
        const btnTranslate = document.getElementById('btnTranslate');
        const btnExport = document.getElementById('btnExport');
        const btnExportCSV = document.getElementById('btnExportCSV');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const sourceLangSelect = document.getElementById('sourceLang');
        const scriptUrlInput = document.getElementById('scriptUrl');

        if(localStorage.getItem('gas_url')) {
            scriptUrlInput.value = localStorage.getItem('gas_url');
        }

        // 1. è¯»å–æ–‡ä»¶ (å¸¦ UTF-8 ä¿®å¤)
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    globalWorkbook = XLSX.read(data, {
                        type: 'array',
                        codepage: 65001 // 65001 ä»£è¡¨ UTF-8
                    });
                    const ws = globalWorkbook.Sheets[globalWorkbook.SheetNames[0]];
                    globalData = XLSX.utils.sheet_to_json(ws, {header: 1});
                    if(globalData.length === 0) {
                        statusDiv.innerText = "âŒ æ–‡ä»¶æ˜¯ç©ºçš„ï¼";
                        return;
                    }
                    renderTable();
                    statusDiv.innerText = `âœ… å·²åŠ è½½: ${file.name} (å…± ${globalData.length} è¡Œ)`;
                } catch(err) {
                    console.error("Read Error:", err);
                    statusDiv.innerText = `âŒ è¯»å–æ–‡ä»¶å¤±è´¥: ${err.message}`;
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function renderTable() {
            table.innerHTML = '';
            if (globalData.length === 0) return;
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            globalData[0].forEach((cell, index) => {
                const th = document.createElement('th');
                th.innerText = cell ? String(cell).substring(0, 20) : `Col ${index+1}`;
                th.onclick = () => selectColumn(index);
                if (index === selectedColIndex) th.classList.add('selected-header');
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            const limit = Math.min(globalData.length, 50); 
            for (let i = 1; i < limit; i++) {
                const row = document.createElement('tr');
                const rowData = globalData[i];
                const maxCols = globalData[0].length;
                for (let j = 0; j < maxCols; j++) {
                    const td = document.createElement('td');
                    td.innerText = rowData[j] ? String(rowData[j]).substring(0, 50) : '';
                    if (j === selectedColIndex) td.classList.add('selected-col');
                    row.appendChild(td);
                }
                tbody.appendChild(row);
            }
            table.appendChild(tbody);
        }

        function selectColumn(index) {
            selectedColIndex = index;
            renderTable();
            btnTranslate.disabled = false;
            statusDiv.innerText = `å·²é€‰ä¸­ç¬¬ ${index+1} åˆ—`;
        }

        async function fetchBatchTranslate(textArray, sourceLang, targetLang) {
            const apiUrl = scriptUrlInput.value.trim();
            const payload = { texts: textArray, source: sourceLang, target: targetLang };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                
                const resultText = await response.text();
                try {
                    const jsonResponse = JSON.parse(resultText);
                    if (jsonResponse.status === "success") {
                        return jsonResponse.data;
                    } else {
                        console.error("GAS Error:", jsonResponse.message);
                        return null;
                    }
                } catch(e) {
                    console.error("Invalid JSON:", resultText);
                    return null;
                }
            } catch (error) {
                console.error("Network Error:", error);
                return null;
            }
        }

        btnTranslate.addEventListener('click', async () => {
            if (selectedColIndex === -1) return;
            const apiUrl = scriptUrlInput.value.trim();
            if (!apiUrl) { alert("è¯·å…ˆç²˜è´´ Google Script URL"); return; }
            localStorage.setItem('gas_url', apiUrl);

            let sourceLang = sourceLangSelect.value;
            if (sourceLang === 'auto') {
                sourceLang = ""; 
            }

            const targetLangInput = document.getElementById('targetLangInput');
            let targetLang = targetLangInput.value.trim();
            if (!targetLang) {
                targetLang = "zh-CN";
            }
            
            btnTranslate.disabled = true;
            progressContainer.style.display = 'block';

            let batchData = [];
            let indices = [];
            const BATCH_SIZE = 50; 

            for (let i = 1; i < globalData.length; i++) {
                let text = globalData[i][selectedColIndex];
                if (text) {
                    batchData.push(String(text));
                    indices.push(i);
                }
            }

            const totalItems = batchData.length;
            let processedCount = 0;
            
            for (let k = 0; k < totalItems; k += BATCH_SIZE) {
                const chunkTexts = batchData.slice(k, k + BATCH_SIZE);
                const chunkIndices = indices.slice(k, k + BATCH_SIZE);
                statusDiv.innerText = `æ­£åœ¨ç¿»è¯‘... ${k}/${totalItems}`;

                const results = await fetchBatchTranslate(chunkTexts, sourceLang, targetLang);

                if (results && results.length === chunkTexts.length) {
                    for (let r = 0; r < results.length; r++) {
                        globalData[chunkIndices[r]][selectedColIndex] = results[r];
                    }
                } else {
                    statusDiv.innerText += "\nâš ï¸ æœ¬æ‰¹æ¬¡ç¿»è¯‘é‡åˆ°ç½‘ç»œæ³¢åŠ¨ï¼Œè·³è¿‡...";
                }

                processedCount += chunkTexts.length;
                progressBar.style.width = Math.round((processedCount / totalItems) * 100) + "%";
                await new Promise(r => setTimeout(r, 200));
            }

            renderTable();
            statusDiv.innerText = "âœ… ç¿»è¯‘å®Œæˆï¼å»ºè®®ä½¿ç”¨ã€é»„è‰²æŒ‰é’®ã€‘å¯¼å‡ºä»¥é˜²ä¹±ç ã€‚";
            btnTranslate.disabled = false;
            btnExport.disabled = false;
            btnExportCSV.disabled = false;
        });

        btnExport.addEventListener('click', () => {
            const newSheet = XLSX.utils.aoa_to_sheet(globalData);
            const newWorkbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWorkbook, newSheet, "Translated");
            XLSX.writeFile(newWorkbook, "Translated_Result.xlsx");
        });

        btnExportCSV.addEventListener('click', () => {
            const ws = XLSX.utils.aoa_to_sheet(globalData);
            const csvContent = XLSX.utils.sheet_to_csv(ws);
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "Translated_Fix_GBK.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // ==========================================
        //  ğŸ‘‡ æ¨¡å— 2ï¼šæ™ºèƒ½åŒ¹é… (VLOOKUP å®šç‚¹å†™å…¥ç‰ˆ)
        // ==========================================
        
        let mainTableData = [];
        let lookupTableData = [];
        let mergedData = [];

        // è·å–å…ƒç´ 
        const mainFileInput = document.getElementById('mainFileInput');
        const lookupFileInput = document.getElementById('lookupFileInput');
        
        const mainKeySelect = document.getElementById('mainKeySelect');
        const mainTargetSelect = document.getElementById('mainTargetSelect'); // ğŸŸ¢ æ–°å¢ï¼šç›®æ ‡å†™å…¥åˆ—
        
        const lookupKeySelect = document.getElementById('lookupKeySelect');
        const lookupValueSelect = document.getElementById('lookupValueSelect');
        
        const btnMatch = document.getElementById('btnMatch');
        const btnExportMerged = document.getElementById('btnExportMerged');
        const matchStatus = document.getElementById('matchStatus');

        // é€šç”¨è¯»å–å‡½æ•°
        function readExcelForVlookup(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', codepage: 65001 });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    callback(jsonData);
                } catch (err) {
                    alert("è¯»å–å¤±è´¥: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // å¡«å……ä¸‹æ‹‰èœå•
        function populateSelect(selectElement, headers) {
            selectElement.innerHTML = '';
            headers.forEach((header, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.text = header ? String(header).substring(0,30) : `Column ${index + 1}`;
                selectElement.appendChild(option);
            });
        }

        // ç›‘å¬ä¸»è¡¨
        mainFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('mainFileStatus').innerText = "âœ… " + file.name;
            readExcelForVlookup(file, (data) => {
                mainTableData = data;
                if (data.length > 0) {
                    populateSelect(mainKeySelect, data[0]);     // å…³è”åˆ—
                    populateSelect(mainTargetSelect, data[0]);  // ğŸŸ¢ ç›®æ ‡å†™å…¥åˆ—
                    checkReady();
                }
            });
        });

        // ç›‘å¬å‰¯è¡¨
        lookupFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('lookupFileStatus').innerText = "âœ… " + file.name;
            readExcelForVlookup(file, (data) => {
                lookupTableData = data;
                if (data.length > 0) {
                    populateSelect(lookupKeySelect, data[0]);
                    populateSelect(lookupValueSelect, data[0]);
                    checkReady();
                }
            });
        });

        function checkReady() {
            if (mainTableData.length > 0 && lookupTableData.length > 0) {
                btnMatch.disabled = false;
                matchStatus.innerText = "å°±ç»ªï¼è¯·é€‰æ‹©å¥½ 4 ä¸ªä¸‹æ‹‰é€‰é¡¹ã€‚";
            }
        }

        // ğŸŸ¢ æ ¸å¿ƒé€»è¾‘ï¼šå®šç‚¹è¦†ç›–
        btnMatch.addEventListener('click', () => {
            const mainKeyIndex = parseInt(mainKeySelect.value);
            const mainTargetIndex = parseInt(mainTargetSelect.value); // è·å–å†™å…¥ä½ç½®
            const lookupKeyIndex = parseInt(lookupKeySelect.value);
            const lookupValueIndex = parseInt(lookupValueSelect.value);

            if (isNaN(mainKeyIndex) || isNaN(mainTargetIndex) || isNaN(lookupKeyIndex) || isNaN(lookupValueIndex)) {
                alert("è¯·ç¡®ä¿æ‰€æœ‰ 4 ä¸ªä¸‹æ‹‰é€‰é¡¹éƒ½å·²é€‰æ‹©ï¼");
                return;
            }

            // å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢æŠŠ Key åˆ—ç»™è¦†ç›–äº†
            if (mainKeyIndex === mainTargetIndex) {
                if(!confirm("âš ï¸ è­¦å‘Šï¼š\nä½ é€‰æ‹©çš„ã€å†™å…¥åˆ—ã€‘å’Œã€å…³è”åˆ—ã€‘æ˜¯åŒä¸€åˆ—ï¼\n\nè¿™ä¼šå¯¼è‡´åŸæœ¬ç”¨æ¥åŒ¹é…çš„ ID è¢«è¦†ç›–æ‰ã€‚\nä½ ç¡®å®šè¦è¿™æ ·åšå—ï¼Ÿ")) {
                    return;
                }
            }

            matchStatus.innerText = "â³ æ­£åœ¨æ„å»ºç´¢å¼•...";

            // A. å»ºç«‹ç´¢å¼•
            const lookupMap = new Map();
            for (let i = 1; i < lookupTableData.length; i++) {
                const row = lookupTableData[i];
                let rawKey = row[lookupKeyIndex];
                let key = (rawKey === undefined || rawKey === null) ? "" : String(rawKey).trim().toUpperCase();
                
                let value = row[lookupValueIndex];
                if (value === undefined || value === null) value = ""; 
                
                if (key) {
                    lookupMap.set(key, value);
                }
            }

            // B. éå†å¹¶è¦†ç›–
            mergedData = JSON.parse(JSON.stringify(mainTableData)); // æ·±æ‹·è´
            let matchCount = 0;

            for (let i = 1; i < mergedData.length; i++) {
                const row = mergedData[i];
                let rawMainKey = row[mainKeyIndex];
                let key = (rawMainKey === undefined || rawMainKey === null) ? "" : String(rawMainKey).trim().toUpperCase();
                
                if (lookupMap.has(key)) {
                    const matchedValue = lookupMap.get(key);
                    
                    // ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šç›´æ¥å†™å…¥åˆ°æŒ‡å®šçš„åˆ—ï¼Œè€Œä¸æ˜¯ push åˆ°æœ€å
                    // å¦‚æœè¯¥è¡Œé•¿åº¦ä¸å¤Ÿï¼Œå…ˆè¡¥é½ç©ºå­—ç¬¦ä¸²ï¼Œé˜²æ­¢æŠ¥é”™
                    while (row.length <= mainTargetIndex) {
                        row.push("");
                    }
                    
                    row[mainTargetIndex] = matchedValue; // ğŸ‘ˆ è¿™é‡Œæ‰§è¡Œè¦†ç›–å†™å…¥
                    matchCount++;
                }
                // ğŸ’¡ æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿™é‡Œä¿æŒåŸçŠ¶ï¼Œä¸åŠ¨å®ƒ
            }

            if (matchCount === 0) {
                alert("âš ï¸ åŒ¹é…ç»“æœä¸º 0 æ¡ï¼è¯·æ£€æŸ¥å…³è”åˆ—æ˜¯å¦é€‰å¯¹ã€‚");
                matchStatus.innerText = "âŒ åŒ¹é…å¤±è´¥ï¼š0 æ¡æ•°æ®ã€‚";
            } else {
                alert(`âœ… å†™å…¥æˆåŠŸï¼\n\nå…±è¦†ç›–/å¡«å…¥äº† ${matchCount} æ¡æ•°æ®ã€‚\nè¯·å¯¼å‡ºæŸ¥çœ‹ã€‚`);
                matchStatus.innerText = `âœ… å®Œæˆï¼å…±å†™å…¥ ${matchCount} æ¡ã€‚è¯·ç‚¹å‡»é»„è‰²æŒ‰é’®å¯¼å‡ºã€‚`;
                btnExportMerged.disabled = false;
            }
        });

        // å¯¼å‡º (å¸¦æŠ¥é”™æ£€æµ‹)
        btnExportMerged.addEventListener('click', () => {
            try {
                if (!mergedData || mergedData.length === 0) return;
                const newSheet = XLSX.utils.aoa_to_sheet(mergedData);
                const newWorkbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(newWorkbook, newSheet, "MergedData");
                XLSX.writeFile(newWorkbook, "Vlookup_Result.xlsx");
                alert("âœ… å¯¼å‡ºæˆåŠŸï¼");
            } catch (err) {
                alert("âŒ å¯¼å‡ºå¤±è´¥ï¼šè¯·å…³é—­æ­£åœ¨æ‰“å¼€çš„ Excel æ–‡ä»¶é‡è¯•ï¼");
            }
        });

    </script>
</body>
</html>